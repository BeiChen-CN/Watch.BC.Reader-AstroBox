(()=>{"use strict";let e;var t={},n={};function r(e){var i=n[e];if(void 0!==i)return i.exports;var o=n[e]={exports:{}};return t[e](o,o.exports,r),o.exports}function i(e){let t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r,i=e.length;for(r=2;r<i;r+=3)n+=t[e[r-2]>>2],n+=t[(3&e[r-2])<<4|e[r-1]>>4],n+=t[(15&e[r-1])<<2|e[r]>>6],n+=t[63&e[r]];return r===i+1&&(n+=t[e[r-2]>>2],n+=t[(3&e[r-2])<<4],n+="=="),r===i&&(n+=t[e[r-2]>>2],n+=t[(3&e[r-2])<<4|e[r-1]>>4],n+=t[(15&e[r-1])<<2],n+="="),n}function o(e){if((e=e.replace(/[\r\n\s]/g,"")).length%4!=0)throw Error("Invalid base64 string length");let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0;e.endsWith("==")?n=2:e.endsWith("=")&&(n=1);let r=e.length/4*3-n,i=new Uint8Array(r),o=0;for(let n=0;n<e.length;n+=4){let s=t.indexOf(e[n])<<18|t.indexOf(e[n+1])<<12|t.indexOf(e[n+2])<<6|t.indexOf(e[n+3]);o<r&&(i[o++]=s>>16&255),o<r&&(i[o++]=s>>8&255),o<r&&(i[o++]=255&s)}return i}async function s(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.debug)?void 0:n.sendRaw))await globalThis.AstroBox.debug.sendRaw(i(e));else throw Error("AstroBox.debug.sendRaw not available on native side")}async function a(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.disconnectDevice))await globalThis.AstroBox.device.disconnectDevice();else throw Error("AstroBox.device.disconnectDevice not available on native side")}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r;r=n[t],t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r})}return e}async function c(e){var t,n;let r=l({decode_text:!1,encoding:"undefined"},e);if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.pickFile))return JSON.parse(await globalThis.AstroBox.filesystem.pickFile(JSON.stringify(r)));throw Error("AstroBox.filesystem.pickFile not available")}async function h(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.filesystem)?void 0:r.readFile)){let n=l({offset:0,decode_text:!0},t);var i=await globalThis.AstroBox.filesystem.readFile(e,JSON.stringify(n));return n.decode_text?i:o(i)}throw Error("AstroBox.filesystem.readFile not available")}async function u(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.filesystem)?void 0:n.unloadFile))return await globalThis.AstroBox.filesystem.unloadFile(e);throw Error("AstroBox.filesystem.unloadFile not available")}function d(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.installer)?void 0:r[e]))globalThis.AstroBox.installer[e](t);else throw Error("AstroBox.installer.".concat(e," not available"))}r.rv=()=>"1.7.2",r.ruid="bundler=rspack@1.7.2";async function f(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.interconnect)?void 0:r.sendQAICMessage))await globalThis.AstroBox.interconnect.sendQAICMessage(e,t);else throw Error("AstroBox.interconnect.sendQAICMessage not available")}async function v(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.network)?void 0:r.fetch)){t.body_encoded="string"!=typeof t.body,t.body=t.body?t.body_encoded?i(t.body):t.body:"";let n=await globalThis.AstroBox.network.fetch(e,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r;r=n[t],t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r})}return e}({raw:!1},t)));return n.body=t.raw?o(n.body):n.body,n}throw Error("AstroBox.network.fetch not available")}async function p(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.provider)?void 0:n.registerCommunityProvider))await globalThis.AstroBox.provider.registerCommunityProvider(JSON.stringify(e));else throw Error("AstroBox.provider.registerCommunityProvider not available")}async function g(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.thirdpartyapp)?void 0:r.launchQA))await globalThis.AstroBox.thirdpartyapp.launchQA(JSON.stringify(e),t);else throw Error("AstroBox.thirdpartyapp.launchQA not available")}async function y(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.thirdpartyapp)?void 0:t.getThirdPartyAppList))return JSON.parse(await globalThis.AstroBox.thirdpartyapp.getThirdPartyAppList());throw Error("AstroBox.thirdpartyapp.getThirdPartyAppList not available")}function b(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.ui)?void 0:r[e]))globalThis.AstroBox.ui[e](t);else throw Error("AstroBox.ui.".concat(e," not available"))}let x={};function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}x.config={},x.config.readConfig=function(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.config)?void 0:t.readConfig))return JSON.parse(globalThis.AstroBox.config.readConfig());throw Error("AstroBox.config.readConfig not available on native side")},x.config.writeConfig=function(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.config)?void 0:n.writeConfig))globalThis.AstroBox.config.writeConfig(JSON.stringify(e));else throw Error("AstroBox.config.writeConfig not available on native side")},x.debug={},x.debug.sendRaw=s,x.device={},x.device.getDeviceList=function(){var e,t;if("function"==typeof(null==(t=null==(e=globalThis.AstroBox)?void 0:e.device)?void 0:t.getDeviceList))return JSON.parse(globalThis.AstroBox.device.getDeviceList());throw Error("AstroBox.device.getDeviceList not available on native side")},x.device.getDeviceState=function(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.device)?void 0:n.getDeviceState))return JSON.parse(globalThis.AstroBox.device.getDeviceState(e));throw Error("AstroBox.device.getDeviceState not available on native side")},x.device.modifyDeviceState=function(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.device)?void 0:r.modifyDeviceState))globalThis.AstroBox.device.modifyDeviceState(e,JSON.stringify(t));else throw Error("AstroBox.device.modifyDeviceState not available on native side")},x.device.disconnectDevice=a,x.event={},x.event.addEventListener=function(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:r.addEventListener))globalThis.AstroBox.event.addEventListener(e,t);else throw Error("AstroBox.event.addEventListener not available")},x.event.removeEventListener=function(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.event)?void 0:n.removeEventListener))globalThis.AstroBox.event.removeEventListener(e);else throw Error("AstroBox.event.removeEventListener not available")},x.event.sendEvent=function(e,t){var n,r;if("function"==typeof(null==(r=null==(n=globalThis.AstroBox)?void 0:n.event)?void 0:r.sendEvent))globalThis.AstroBox.event.sendEvent(e,t);else throw Error("AstroBox.event.sendEvent not available")},x.installer={},x.installer.addThirdPartyAppToQueue=e=>d("addThirdPartyAppToQueue",e),x.installer.addWatchFaceToQueue=e=>d("addWatchFaceToQueue",e),x.installer.addFirmwareToQueue=e=>d("addFirmwareToQueue",e),x.interconnect={},x.interconnect.sendQAICMessage=f,x.lifecycle={},x.lifecycle.onLoad=function(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.lifecycle)?void 0:n.onLoad))globalThis.AstroBox.lifecycle.onLoad(e);else throw Error("AstroBox.lifecycle.onLoad not available")},x.native={},x.native.regNativeFun=function(e){var t,n;if("function"==typeof(null==(n=null==(t=globalThis.AstroBox)?void 0:t.native)?void 0:n.regNativeFun))return globalThis.AstroBox.native.regNativeFun(e);throw Error("AstroBox.native.regNativeFun not available")},x.network={},x.network.fetch=v,x.provider={},x.provider.registerCommunityProvider=p,x.thirdpartyapp={},x.thirdpartyapp.launchQA=g,x.thirdpartyapp.getThirdPartyAppList=y,x.ui={},x.ui.updatePluginSettingsUI=e=>b("updatePluginSettingsUI",JSON.stringify(e)),x.ui.openPageWithNodes=e=>b("openPageWithNodes",JSON.stringify(e)),x.ui.openPageWithUrl=e=>b("openPageWithUrl",e),x.filesystem={},x.filesystem.pickFile=c,x.filesystem.readFile=h,x.filesystem.unloadFile=u;class w{addListener(e,t){this.listeners.set(e,t)}removeListener(e){this.listeners.delete(e)}send(e,t){return x.interconnect.sendQAICMessage(this.packageName,JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){m(e,t,n[t])})}return e}({tag:e},t)))}constructor(e){m(this,"listeners",new Map),m(this,"packageName",void 0),this.packageName=e}}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let A="__hs__";class B extends w{async send(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.connected||(this.promise?await this.promise:await (this.promise=this._newPromise())),await super.send(...t)}setHandshakeListener(e){this.callback=e}get isConnected(){return this.connected}_newPromise(){return new Promise((e,t)=>{let n=setTimeout(()=>{t(Error("timeout")),this.promise=this.resolve=null},3e3);this.resolve=()=>{e(),clearTimeout(n),this.connected=!0},super.send(A,{count:0})})}constructor(e){super(e),C(this,"promise",null),C(this,"resolve",null),C(this,"timeout",null),C(this,"connected",!1),C(this,"callback",()=>{}),x.event.addEventListener("onQAICMessage_".concat(e),e=>{var t;this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.promise=this.resolve=null,this.connected=!1},3e3);let n=JSON.parse(e),{tag:r}=n,i=function(e,t){if(null==e)return{};var n,r,i,o={};if("u">typeof Reflect&&Reflect.ownKeys){for(i=0,n=Reflect.ownKeys(e);i<n.length;i++)r=n[i],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r]);return o}if(o=function(e,t){if(null==e)return{};var n,r,i={},o=Object.getOwnPropertyNames(e);for(r=0;r<o.length;r++)n=o[r],!(t.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n]);return i}(e,t),Object.getOwnPropertySymbols)for(i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)r=n[i],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r]);return o}(n,["tag"]);null==(t=this.listeners.get(r))||t(i)}),this.addListener(A,e=>{let{count:t}=e;if(t>0)if(this.promise){var n;null==(n=this.resolve)||n.call(this),this.resolve=null,this.promise=null,this.connected=!0}else this.promise=Promise.resolve(),this.callback();t++<2&&super.send(A,{count:t})})}}function T(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===e)return"0 Bytes";let n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(t<0?0:t))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function k(e){var t;return e&&null!=(t=e.replace(/\\/g,"/").split("/").pop())?t:""}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class S{async sendFile(e,t,n,r,i,o,s){if(this.busy)return void s("传输正在进行中",0);this.busy=!0,this.onProgress=i,this.onSuccess=o,this.onError=s,this.lastChunkTime=0,i(0,"正在读取文件...");try{let n=await x.filesystem.readFile(t,{len:r,decode_text:!0});if(this.chapters=this.parseChapters(n,e),0===this.chapters.length){s("未找到章节",0),this.resetState();return}i(0,"准备发送 ".concat(this.chapters.length," 个章节..."));let o=this.chapters.reduce((e,t)=>e+t.wordCount,0),a=this.chapters.map((e,t)=>t),l={stat:"startTransfer",filename:e,total:this.chapters.length,wordCount:o,startFrom:0,chapterIndices:a,hasCover:!1};await this.conn.send("file",l)}catch(e){this.onError("文件读取失败: ".concat(e.message),0),this.resetState()}}parseChapters(e,t){let n=[],r=[...e.matchAll(/第[零一二三四五六七八九十百千万\d]+[章节回]/g)];if(0===r.length)return[{name:t,content:e,wordCount:e.length}];for(let t=0;t<r.length;t++){let i=r[t],o=i.index,s=t<r.length-1?r[t+1].index:e.length,a=e.substring(o,s).trim(),l=i[0];n.push({name:l,content:a,wordCount:a.length})}return n}async sendNextChapter(e){if(e<0||e>=this.chapters.length){this.onError("无效的章节索引: ".concat(e),e),this.resetState();return}this.currentChapterIndex=e;let t=this.chapters[e];this.currentChapterChunks=this.chunkString(t.content,this.CHUNK_SIZE),this.currentChunkIndex=0,this.currentChapterChunks.length>0&&(this.nextChunk=Promise.resolve(this.currentChapterChunks[0])),this.sendCurrentChunk()}chunkString(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(e.substring(r,r+t));return n}async sendCurrentChunk(){if(this.currentChunkIndex>=this.currentChapterChunks.length)return void console.error("sendCurrentChunk called in invalid state");let e=this.chapters[this.currentChapterIndex],t=await this.nextChunk,n=this.currentChapterChunks.length,r=JSON.stringify({index:this.currentChapterIndex,name:e.name,content:t,wordCount:e.wordCount,chunkNum:this.currentChunkIndex,totalChunks:n}),i={stat:"d",count:this.currentChapterIndex,data:r},o=Date.now();this.currentChunkIndex+1<n&&(this.nextChunk=Promise.resolve(this.currentChapterChunks[this.currentChunkIndex+1]));try{await this.conn.send("file",i);let r=(this.currentChapterIndex+(this.currentChunkIndex+1)/n)/this.chapters.length;if(0!==this.lastChunkTime){let i=o-this.lastChunkTime;if(i>0){let o=t.length/(i/1e3);this.onProgress(r,"".concat(e.name," (").concat(this.currentChunkIndex+1,"/").concat(n,") ").concat(T(o),"/s"))}else this.onProgress(r,"".concat(e.name," (").concat(this.currentChunkIndex+1,"/").concat(n,")"))}else this.onProgress(r,"".concat(e.name," (").concat(this.currentChunkIndex+1,"/").concat(n,")"));this.lastChunkTime=o}catch(e){this.onError("发送失败: ".concat(e.message),this.currentChapterIndex),this.resetState()}}async sendChapterComplete(){try{let e={stat:"chapter_complete",count:this.currentChapterIndex};await this.conn.send("file",e)}catch(e){this.onError("章节完成命令发送失败: ".concat(e.message),this.currentChapterIndex),this.resetState()}}async sendTransferComplete(){try{await this.conn.send("file",{stat:"transfer_complete"})}catch(e){console.error("Failed to send transfer_complete",e),this.onProgress(1,"传输完成"),this.onSuccess("传输完成",this.chapters.length),this.resetState()}}cancel(){this.busy&&(this.conn.send("file",{stat:"cancel"}).catch(e=>{console.error("发送取消消息失败",e)}),this.resetState())}resetState(){this.busy=!1,this.chapters=[],this.currentChapterIndex=0,this.currentChapterChunks=[],this.currentChunkIndex=0,this.lastChunkTime=0,this.nextChunk=Promise.resolve("")}constructor(e){O(this,"conn",void 0),O(this,"CHUNK_SIZE",10240),O(this,"busy",!1),O(this,"lastChunkTime",0),O(this,"chapters",[]),O(this,"currentChapterIndex",0),O(this,"currentChapterChunks",[]),O(this,"currentChunkIndex",0),O(this,"nextChunk",Promise.resolve("")),O(this,"onError",()=>{}),O(this,"onSuccess",()=>{}),O(this,"onProgress",()=>{}),this.conn=e,this.conn.addListener("file",e=>{if(this.busy&&e)try{switch(e.type){case"ready":if(e.usage>0x1900000){this.onError("存储空间不足",0),this.resetState();return}this.sendNextChapter(0);break;case"error":this.onError(e.message,e.count),this.resetState();break;case"success":this.onProgress(1,"传输完成"),this.onSuccess(e.message,e.count),this.resetState();break;case"next":this.sendNextChapter(e.count);break;case"next_chunk":this.currentChunkIndex++,this.sendCurrentChunk();break;case"chapter_chunk_complete":this.sendChapterComplete();break;case"chapter_saved":let t=this.currentChapterIndex+1;t>=this.chapters.length?this.sendTransferComplete():this.sendNextChapter(t);break;case"transfer_finished":this.onProgress(1,"传输完成"),this.onSuccess("传输完成",this.chapters.length),this.resetState();break;case"cancel":this.onSuccess("传输已取消",0),this.resetState()}}catch(t){console.error("Error processing file message:",e,t),this.onError("解析消息失败",0),this.resetState()}})}}let E=null,P=0,I=x.native.regNativeFun(()=>j()),N=x.native.regNativeFun(()=>D()),_=x.native.regNativeFun(()=>J()),F=[{node_id:"pickFile",visibility:!0,disabled:!1,content:{type:"Button",value:{primary:!0,text:"选择文件",callback_fun_id:I}}},{node_id:"send",visibility:!0,disabled:!0,content:{type:"Button",value:{primary:!0,text:"发送文件",callback_fun_id:N}}},{node_id:"filename",visibility:!0,disabled:!1,content:{type:"Text",value:"未选择文件"}},{node_id:"tip",visibility:!0,disabled:!1,content:{type:"Text",value:"请选择 TXT 电子书文件"}}];function L(){x.ui.updatePluginSettingsUI(F)}async function j(){try{(null==E?void 0:E.path)&&await x.filesystem.unloadFile(E.path)}catch(e){console.error(e),F[2].content.value=e.message,L()}let e=k((E=await x.filesystem.pickFile({decode_text:!0})).path);F[2]={node_id:"filename",visibility:!0,disabled:!1,content:{type:"Text",value:"".concat(e,"\n").concat(T(E.size))}},F[1].disabled=!1,L()}async function D(){if(E){F[0].disabled=!0,F[1].content.value.text="取消",F[1].content.value.callback_fun_id=_,L();try{let t=(await x.thirdpartyapp.getThirdPartyAppList()).find(e=>"Watch.BC.Reader"==e.package_name);if(!t)return F[2].content.value="请先安装 BcReader 快应用",L();await x.thirdpartyapp.launchQA(t,"Watch.BC.Reader"),await new Promise(e=>setTimeout(e,3e3));let n=k(E.path).replace(/\.[^/.]+$/,"");await e.sendFile(n,E.path,E.size,E.text_len,Q,M,R)}catch(e){console.error(e),F[2].content.value=e.message,L()}}}async function J(){e.cancel(),F[0].disabled=!1,F[1].content.value.text="发送文件",F[1].content.value.callback_fun_id=N,L()}function Q(e,t){let n=Date.now();n-P>200&&(F[2].content.value="".concat(t," ").concat((100*e).toFixed(2),"%"),L(),P=n)}function M(e,t){F[2].content.value="发送成功: ".concat(e),L()}function R(e,t){F[2].content.value="发送失败: ".concat(e),L()}x.lifecycle.onLoad(()=>{console.log("Plugin on LOAD!"),L(),e=new S(new B("Watch.BC.Reader"))})})();
//# sourceMappingURL=main.js.map